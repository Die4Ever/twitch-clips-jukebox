<!DOCTYPE html>
<!-- https://dev.twitch.tv/docs/embed/video-and-clips/ -->
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Twitch Clips Jukebox</title>
</head>
<body style="margin:0; overflow:hidden; background:black;">
    <div id="clipplayer" style="width:100vw; height:100vh;"></div>
    <div class="info" style="position:absolute;top:1rem;right:1rem;color:white;"></div>
</body>

<!--<script src="https://player.twitch.tv/js/embed/v1.js"></script>-->
<script type="text/javascript">
    //you might need to go to chrome://settings/content/siteDetails?site=http%3A%2F%2Fraycarro.com and set Sound to Allow
    var playlist = [];

    var broadcasterID=22510310;
    var broadcasterName;//pull this and gameName from the clip data or cache
    var gameID;
    var gameName;

    var started_at;//RFC3339 format, looks like Date::toISOString() outputs this format
    var ended_at;
    var after;
    var first = 25;//number of clips to get each ajax request

    var min_time_difference = 120;//minimum number of seconds between the creation date of 2 clips, otherwise they are considered duplicates and the one with more views is chosen

    var status = 'ended';

    var viewhistory = {};
    var storedhistory = localStorage.getItem('history');
    try {
        storedhistory = JSON.parse(storedhistory);
        viewhistory = storedhistory;
    } catch (e) { console.log('failed to load history', e); }
    /*try {
        after = JSON.parse(localStorage.getItem('after'));
    } catch (e) { console.log('failed to load after cursor'); }*/

    function ajaxPost(data, callback) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4) callback( JSON.parse(this.responseText), this );
        };
        xhttp.open("POST", "getclips.py", true);
        xhttp.setRequestHeader("Content-type", "application/json; charset=utf-8");
        xhttp.send(JSON.stringify(data));
        return xhttp;
    }

    function seenSecondsAgo(clipId) {
        //return how many seconds it's been since we last saw this clip
        if (!viewhistory[clipId]) return null;
        var d = (new Date()).getTime();
        return (d - viewhistory[clipId].seen)/1000;
    }

    function addToHistory(clipId, clipData) {
        //add to localStorage that we've seen this clip with the current datetime
        //also could save some data about the clip for statistics like view count so we can see how much it's gone up?
        //maybe that should be a separate entry and save it for all clips retreived not just the ones watched?
        //should we save the current playlist in localStorage?
        viewhistory[clipId] = clipData;
        viewhistory[clipId]['seen'] = (new Date()).getTime();
        localStorage.setItem('history', JSON.stringify(viewhistory));
    }

    function getMoreClips() {
        if (playlist.length > 3) return;

        //if no broadcasterID or gameID, we need to retrieve those by the name given in the url
        //https://dev.twitch.tv/docs/api/reference/#get-users
        //https://dev.twitch.tv/docs/api/reference/#get-games
        //might even wanna cache these in localStorage to save on my API quota

        //make ajax call for https://dev.twitch.tv/docs/api/reference/#get-clips
        var request_data = { path: 'clips' };
        request_data['broadcaster_id'] = broadcasterID;
        if (after)
            request_data['after'] = after;
        ajaxPost(request_data, function (d) {
            after = d.pagination.cursor;
            for (var i = 0; i < d.data.length; i++) {
                var c = d.data[i];
                playlist.push(c);
                //add broadcaster and game to cache? don't really have a need to cache them anymore?
            }

            if (status === 'ended')
                playNextVideo();
        });
    }

    function emptyNode(node) {
        while (node.firstChild)
            node.firstChild.remove();
    }

    function updateClipInfo(clip) {

    }

    function playClip(clip) {
        console.log('playing ' + clip.id);
        status = 'playing';
        addToHistory(clip.id, clip);
        var playerParent = document.getElementById('clipplayer');
        emptyNode(playerParent);
        var el = document.createElement('iframe');
        el.id = "clip";
        el.width = "100%";
        el.height = "100%";
        el.allowFullscreen = "true";//fullscreen might not work, might have to just fullscreen the page since the iframe takes up my whole page anyways
        el.scrolling = "no";
        el.frameBorder = "0";
        el.src = "https://clips.twitch.tv/embed?muted=false&autoplay=true&clip=" + clip.id + "&origin=http%3A%2F%2Fraycarro.com";
        playerParent.appendChild(el);
        //document.querySelector('iframe').contentWindow.postMessage('', '*');//don't seem to need this?
        updateClipInfo(clip);
    }

    function playNextVideo() {
        getMoreClips();

        if (playlist.length === 0) {
            console.warn('playlist is empty');
            return;
        }
        while (playlist.length > 0) {
            var v = playlist.shift();
            var secondsAgo = seenSecondsAgo(v.id);
            if ( secondsAgo > 86400*30 || secondsAgo === null ) {
                playClip(v);
                break;
            }
        }
    }

    //https://stackoverflow.com/a/9154267
    window.onmessage = function (e) {
        if (e.data.method === 'bridgeplayerevent' && e.data.args[0].event === 'ended') {
            console.log('got ended message', e.data);
            status = 'ended';
            playNextVideo();
        } else if (e.data.method === 'bridgeplayerevent') {
            console.log('got other message '+e.data.args[0].event, e.data);
        }
    };

    playNextVideo();

    /*var options = {
        width: '100%',
        height: '100%',
        //clip: "AwkwardHelplessSalamanderSwiftRage"
        channel: 'sesswole'
    };
    var player = new Twitch.Player("clipplayer", options);
    player.setClip('LightRoundWalletJonCarnage');
    player.play();
      //player.setVolume(0.5);*/
</script>
